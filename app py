from flask import Flask, request, jsonify
import requests
import json
import threading
import time
from datetime import datetime
import schedule

app = Flask(__name__)

# Ä°stek geÃ§miÅŸini saklamak iÃ§in
request_history = []

# VarsayÄ±lan email (DEÄÄ°ÅTÄ°RMENÄ°Z GEREKÄ°R)
DEFAULT_EMAIL = "ornek@email.com"  # BURAYI KENDÄ° EMAÄ°LÄ°NÄ°ZLE DEÄÄ°ÅTÄ°RÄ°N

def make_request(email):
    """API'ye istek gÃ¶nderen fonksiyon"""
    try:
        url = "https://email-to-user.onrender.com/email_to_user"
        data = {
            "email": email,
            "dev": "@Z4usXcode"
        }
        
        print(f"[{datetime.now()}] {email} iÃ§in istek gÃ¶nderiliyor...")
        
        response = requests.post(url, json=data, timeout=10)
        
        result = {
            "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "email": email,
            "status_code": response.status_code,
            "response": response.json() if response.status_code == 200 else {"error": "Ä°stek baÅŸarÄ±sÄ±z"}
        }
        
        # GeÃ§miÅŸe ekle (max 50 kayÄ±t)
        request_history.append(result)
        if len(request_history) > 50:
            request_history.pop(0)
            
        print(f"[{datetime.now()}] Ä°stek tamamlandÄ±. Durum: {response.status_code}")
        return result
        
    except Exception as e:
        error_result = {
            "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "email": email,
            "status_code": "ERROR",
            "response": {"error": str(e)}
        }
        request_history.append(error_result)
        if len(request_history) > 50:
            request_history.pop(0)
        print(f"[{datetime.now()}] Hata: {str(e)}")
        return error_result

def schedule_requests(email, interval_minutes=5):
    """Periyodik istekleri planlayan fonksiyon"""
    def job():
        make_request(email)
    
    # Schedule'Ä± temizle
    schedule.clear()
    
    # Yeni schedule oluÅŸtur
    schedule.every(interval_minutes).minutes.do(job)
    
    print(f"[{datetime.now()}] {email} iÃ§in {interval_minutes} dakikada bir istek planlandÄ±")
    
    # Ä°lk isteÄŸi hemen gÃ¶nder
    threading.Thread(target=make_request, args=(email,)).start()
    
    # Schedule loop'u Ã§alÄ±ÅŸtÄ±r
    while True:
        schedule.run_pending()
        time.sleep(1)

# UYGULAMA BAÅLAR BAÅLAMAZ OTOMATÄ°K Ä°STEK BAÅLAT
def start_automatically():
    """Uygulama baÅŸlar baÅŸlamaz otomatik istek baÅŸlat"""
    print(f"[{datetime.now()}] OTOMATÄ°K BAÅLATILIYOR: {DEFAULT_EMAIL}")
    thread = threading.Thread(
        target=schedule_requests,
        args=(DEFAULT_EMAIL, 5),  # 5 dakikada bir
        daemon=True
    )
    thread.start()

@app.route('/')
def index():
    """Ana sayfa - Basit HTML arayÃ¼zÃ¼"""
    return f"""
    <!DOCTYPE html>
    <html>
    <head>
        <title>Email API Ä°stek YÃ¶neticisi</title>
        <style>
            body {{
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f5f5;
            }}
            .container {{
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }}
            .status {{
                background-color: #d4edda;
                border: 1px solid #c3e6cb;
                color: #155724;
                padding: 10px;
                border-radius: 5px;
                margin-bottom: 20px;
            }}
            .input-group {{
                margin-bottom: 15px;
            }}
            input, select, button {{
                padding: 10px;
                margin: 5px 0;
                width: 100%;
                border: 1px solid #ddd;
                border-radius: 5px;
            }}
            button {{
                background-color: #007bff;
                color: white;
                border: none;
                cursor: pointer;
                font-weight: bold;
            }}
            button:hover {{
                background-color: #0056b3;
            }}
            .history-item {{
                border-left: 4px solid #007bff;
                padding: 10px;
                margin: 10px 0;
                background-color: #f8f9fa;
            }}
            .success {{ border-left-color: #28a745; }}
            .error {{ border-left-color: #dc3545; }}
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸ“§ Email API Ä°stek YÃ¶neticisi</h1>
            
            <div class="status">
                âœ… <strong>OTOMATÄ°K Ã‡ALIÅIYOR</strong><br>
                Email: {DEFAULT_EMAIL}<br>
                SÄ±klÄ±k: 5 dakikada bir<br>
                BaÅŸlangÄ±Ã§: {datetime.now().strftime('%H:%M:%S')}
            </div>
            
            <div class="input-group">
                <h3>Yeni Periyodik Ä°stek BaÅŸlat</h3>
                <input type="email" id="email" placeholder="Yeni email adresini girin">
                <select id="interval">
                    <option value="1">1 dakikada bir</option>
                    <option value="5" selected>5 dakikada bir</option>
                    <option value="10">10 dakikada bir</option>
                </select>
                <button onclick="startRequests()">Yeni Ä°stek BaÅŸlat</button>
                <p><small>Not: Yeni bir email girerseniz, eski istekler durur ve yenisi baÅŸlar</small></p>
            </div>
            
            <div class="input-group">
                <h3>Manuel Tek Ä°stek GÃ¶nder</h3>
                <input type="email" id="manualEmail" placeholder="Test iÃ§in email girin">
                <button onclick="manualRequest()" style="background-color: #28a745;">Tek Ä°stek GÃ¶nder</button>
            </div>
            
            <div class="input-group">
                <h3>Ä°stek GeÃ§miÅŸi (Son 10)</h3>
                <button onclick="loadHistory()" style="background-color: #6c757d;">GeÃ§miÅŸi Yenile</button>
                <button onclick="clearHistory()" style="background-color: #dc3545;">GeÃ§miÅŸi Temizle</button>
                <div id="history"></div>
            </div>
        </div>
        
        <script>
            async function startRequests() {{
                const email = document.getElementById('email').value;
                const interval = document.getElementById('interval').value;
                
                if (!email) {{
                    alert('LÃ¼tfen bir email adresi girin!');
                    return;
                }}
                
                const response = await fetch('/start', {{
                    method: 'POST',
                    headers: {{ 'Content-Type': 'application/json' }},
                    body: JSON.stringify({{ email: email, interval: interval }})
                }});
                
                const result = await response.json();
                alert(result.message);
                loadHistory();
            }}
            
            async function manualRequest() {{
                const email = document.getElementById('manualEmail').value;
                
                if (!email) {{
                    alert('LÃ¼tfen bir email adresi girin!');
                    return;
                }}
                
                const response = await fetch('/manual-request', {{
                    method: 'POST',
                    headers: {{ 'Content-Type': 'application/json' }},
                    body: JSON.stringify({{ email: email }})
                }});
                
                const result = await response.json();
                alert('Ä°stek gÃ¶nderildi! Durum: ' + result.status_code);
                loadHistory();
            }}
            
            async function loadHistory() {{
                const response = await fetch('/history');
                const history = await response.json();
                
                const historyDiv = document.getElementById('history');
                historyDiv.innerHTML = '';
                
                // En yeni kayÄ±tlar Ã¼stte olacak ÅŸekilde sÄ±rala (son 10)
                history.slice().reverse().slice(0, 10).forEach(req => {{
                    const statusClass = req.status_code === 200 ? 'success' : 'error';
                    const statusText = req.status_code === 200 ? 'âœ… BaÅŸarÄ±lÄ±' : 'âŒ Hata';
                    
                    historyDiv.innerHTML += `
                        <div class="history-item ${{statusClass}}">
                            <div><strong>Email:</strong> ${{req.email}}</div>
                            <div><strong>Zaman:</strong> ${{req.timestamp}}</div>
                            <div><strong>Durum:</strong> ${{statusText}} (${{req.status_code}})</div>
                        </div>
                    `;
                }});
            }}
            
            async function clearHistory() {{
                const response = await fetch('/clear-history', {{ method: 'POST' }});
                const result = await response.json();
                alert(result.message);
                loadHistory();
            }}
            
            // Sayfa yÃ¼klendiÄŸinde geÃ§miÅŸi yÃ¼kle
            window.onload = loadHistory;
            
            // Her 10 saniyede bir geÃ§miÅŸi otomatik yenile
            setInterval(loadHistory, 10000);
        </script>
    </body>
    </html>
    """

@app.route('/start', methods=['POST'])
def start_requests():
    """Periyodik istekleri baÅŸlat"""
    data = request.json
    email = data.get('email')
    interval = int(data.get('interval', 5))
    
    if not email:
        return jsonify({"error": "Email gereklidir"}), 400
    
    # Arka planda schedule thread'ini baÅŸlat
    thread = threading.Thread(
        target=schedule_requests,
        args=(email, interval),
        daemon=True
    )
    thread.start()
    
    return jsonify({
        "message": f"{email} iÃ§in {interval} dakikada bir istekler baÅŸlatÄ±ldÄ±",
        "status": "started"
    })

@app.route('/manual-request', methods=['POST'])
def manual_request():
    """Manuel istek gÃ¶nder"""
    data = request.json
    email = data.get('email')
    
    if not email:
        return jsonify({"error": "Email gereklidir"}), 400
    
    result = make_request(email)
    
    return jsonify(result)

@app.route('/history')
def get_history():
    """Ä°stek geÃ§miÅŸini getir"""
    return jsonify(request_history)

@app.route('/clear-history', methods=['POST'])
def clear_history():
    """GeÃ§miÅŸi temizle"""
    request_history.clear()
    return jsonify({"message": "GeÃ§miÅŸ temizlendi"})

if __name__ == '__main__':
    print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘      Email API Ä°stek YÃ¶neticisi BaÅŸlatÄ±lÄ±yor...      â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘ Web ArayÃ¼zÃ¼: http://localhost:5000                   â•‘
    â•‘                                                      â•‘
    â•‘ âš¡ OTOMATÄ°K BAÅLATMA AKTÄ°F!                          â•‘
    â•‘ Email: ornek@email.com                               â•‘
    â•‘ SÄ±klÄ±k: 5 dakikada bir                               â•‘
    â•‘                                                      â•‘
    â•‘ âš  DÄ°KKAT: 'ornek@email.com' yerine kendi            â•‘
    â•‘   email adresinizi yazÄ±n! (app.py dosyasÄ±nda)        â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    # OTOMATÄ°K BAÅLAT
    start_automatically()
    
        import os
    port = int(os.environ.get("PORT", 5000))
    app.run(debug=False, host="0.0.0.0", port=port)
